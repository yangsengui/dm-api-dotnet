name: Publish

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Package version (example: 0.1.0-beta.1)"
        required: false
        default: "0.1.0-beta.1"

jobs:
  publish:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve package version
        id: meta
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "push") {
            $version = "${{ github.ref_name }}".Substring(1)
          } else {
            $version = "${{ inputs.version }}"
          }
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Version input is required."
          }
          "package_version=$version" >> $env:GITHUB_OUTPUT
          "tag_name=v$version" >> $env:GITHUB_OUTPUT
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - run: dotnet restore
      - run: dotnet build -c Release --no-restore
      - name: Pack NuGet package
        shell: pwsh
        run: |
          if (Test-Path dist) { Remove-Item dist -Recurse -Force }
          dotnet pack -c Release --no-build -p:PackageVersion=${{ steps.meta.outputs.package_version }} -o dist
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package-${{ steps.meta.outputs.package_version }}
          path: dist/*
      - name: Publish package to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          prerelease: ${{ contains(steps.meta.outputs.package_version, '-') }}
          generate_release_notes: true
          files: dist/*
      - name: Publish NuGet package
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && env.NUGET_API_KEY != ''
        run: dotnet nuget push "dist/*.nupkg" --source "https://api.nuget.org/v3/index.json" --api-key "${{ env.NUGET_API_KEY }}" --skip-duplicate
